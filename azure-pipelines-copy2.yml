trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'windows-latest'
  # name: ALV-AgentPool-LP01 # Your self-hosted build agent pool

variables:
  nodeVersion: '20.x'
  group: IIS-Deploy-Creds

  # Pick target server based on branch
  ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
    targetServer: 'aib-prod01.ap.autoliv.int'
  ${{ else }}:
    targetServer: 'aib-dev01.ap.autoliv.int'

stages:
  - stage: Build
    jobs:
      - job: Build
        steps:
          # Install Node 20
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          # Verify Node & npm
          - script: |
              node -v
              npm -v
            displayName: 'Verify Node Installed on Agent'

          # Install dependencies
          - script: npm install
            displayName: 'Install dependencies'

          # Build the Vue.js project
          - script: npm run build
            displayName: 'Build the Vue.js project'

          # Verify dist folder exists
          - script: |
              echo "Check for dist folder after build:"
              dir dist
            displayName: 'Verify dist Folder After Build'

          # Publish dist as artifact
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'dist'
              ArtifactName: 'dist'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: Deploy to IIS
    dependsOn: Build
    jobs:
      - job: Deploy
        displayName: 'Deploy to IIS Server'
        steps:
          # Download build artifact
          - task: DownloadBuildArtifacts@0
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'dist'
              downloadPath: '$(Pipeline.Workspace)\dist'

          # Copy files to IIS using WinRM
          - task: WindowsMachineFileCopy@2
            inputs:
              SourcePath: '$(Pipeline.Workspace)\dist'
              MachineNames: '$(targetServer)'
              AdminUserName: '$(DeployUser)'
              AdminPassword: '$(DeployPassword)'
              TargetPath: 'C:\inetpub\wwwroot\sampleapplication01'

          # Restart IIS remotely
          - task: PowerShellOnTargetMachines@3
            inputs:
              MachineNames: '$(targetServer)'
              AdminUserName: '$(DeployUser)'
              AdminPassword: '$(DeployPassword)'
              InlineScript: 'iisreset'
